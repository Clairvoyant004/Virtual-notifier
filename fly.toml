app = "virtual-notifier"
primary_region = "jnb"

[build]
  dockerfile = "Dockerfile"

[env]
  DJANGO_SETTINGS_MODULE = "bet9ja_tracker.settings"
  PYTHONUNBUFFERED = "1"

[deploy]
  release_command = "sh -c 'playwright install chromium && python manage.py migrate'"

[processes]
  web = "gunicorn bet9ja_tracker.wsgi:application --bind 0.0.0.0:8000"
  worker = "sh -c 'xvfb-run --auto-servernum --server-args=\"-screen 0 1280x1024x24\" python manage.py run_tracker || sleep infinity'"

[[services]]
  internal_port = 8000
  protocol = "tcp"
  processes = ["web"]

  [[services.ports]]
    handlers = ["http"]
    port = 80

  [[services.ports]]
    handlers = ["tls", "http"]
    port = 443

  [services.concurrency]
    type = "connections"
    soft_limit = 20
    hard_limit = 25

  [services.tcp_checks]
    interval = "15s"
    timeout = "2s"
    grace_period = "5s"
    restart_limit = 0

[[vm]]
  processes = ["worker"]
  size = "performance-2x"
  memory = "4GB"
  restart = { policy = "always", retries = 10 }

[[statics]]
guest_path = "/bet9ja_tracker/static"
url_prefix = "/static/"

[[services.http_checks]]
interval = 10000
timeout = 2000
path = "/health/"
